<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <title>Objetos de ofrenda</title>
    <style>
        #loader {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #241440; 
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
            font-family: Arial;
            font-size: 18px;
        }
        
        #myCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div id="loader">
        Cargando ofrenda...
    </div>

    <canvas id="myCanvas"></canvas>

    <script src="./font/KG_HAPPY_Regular.js"></script>

    <script type="importmap"> 
        {
            "imports":{
                "three": "./js/three.module.js",
                "three/addons/": "./js/"
            }
        }
    </script>
    <script type="module"> 
        //🗃️🗃️ Mandar llamar a la librería UNA SOLA VEZ
        import * as THREE from 'three'; 
        
        // Hacer THREE disponible globalmente para los módulos
        window.THREE = THREE;
        
        // Ahora importar los controles
        import {OrbitControls} from './js/OrbitControls.js';

        // Importar objetos - con manejo de errores
        let objectModules = {};
        
        async function loadObjectModules() {
            try {
                // Cargar módulos uno por uno con manejo de errores
                objectModules.ESC01 = await import("./objetos/Pan.js").catch(() => null);
                objectModules.ESC02 = await import("./objetos/Vela.js").catch(() => null);
                objectModules.ESC03 = await import("./objetos/Cocacola.js").catch(() => null);
                objectModules.ESC04 = await import("./objetos/Taza1.js").catch(() => null);
                objectModules.ESC05 = await import("./objetos/Taza2.js").catch(() => null);
                objectModules.ESC06 = await import("./objetos/Taza3.js").catch(() => null);
                objectModules.ESC07 = await import("./objetos/Florero.js").catch(() => null);
                objectModules.ESC08 = await import("./objetos/Florero2.js").catch(() => null);
                objectModules.ESC09 = await import("./objetos/Florero3.js").catch(() => null);
                objectModules.ESC10 = await import("./objetos/Copal.js").catch(() => null);
                objectModules.tequila = await import("./objetos/Tequila.js").catch(() => null);
                objectModules.retrato1 = await import("./objetos/Retrato.js").catch(() => null);
                objectModules.retrato2 = await import("./objetos/Retrato2.js").catch(() => null);
                objectModules.retrato3 = await import("./objetos/Retrato3.js").catch(() => null);
                objectModules.agua = await import("./objetos/Agua.js").catch(() => null);
                objectModules.mandarina = await import("./objetos/Mandarina.js").catch(() => null);
                objectModules.MANGO = await import("./objetos/mangoamarillo.js").catch(() => null);
                objectModules.MANZANA = await import("./objetos/Manzana.js").catch(() => null);
                objectModules.CUENCO = await import("./objetos/Cuenco.js").catch(() => null);
                objectModules.Pozole1 = await import("./objetos/pozole.js").catch(() => null);
                objectModules.PisosOfrenda = await import("./objetos/pisosofrenda.js").catch(() => null);
                objectModules.Vinyl = await import("./objetos/cajavinyl.js").catch(() => null);
                objectModules.catrin = await import("./objetos/catrin.js").catch(() => null);
                objectModules.flor = await import("./objetos/flor.js").catch(() => null);
                objectModules.arcoflores = await import("./objetos/arcoflores.js").catch(() => null);
                objectModules.vallas = await import("./objetos/vallas.js").catch(() => null);
                objectModules.farol = await import("./objetos/farol.js").catch(() => null);
                objectModules.farolgrande = await import("./objetos/farol2.js").catch(() => null);
                objectModules.catrina = await import("./objetos/catrina.js").catch(() => null);
                objectModules.whiskey = await import("./objetos/Wis.js").catch(() => null);
                objectModules.Aguan = await import("./objetos/Vaso.js").catch(() => null);
                objectModules.Micro = await import("./objetos/Microfono.js").catch(() => null);
                objectModules.Caballo = await import("./objetos/Caballito.js").catch(() => null);
                objectModules.Crucifijo = await import("./objetos/Cruz.js").catch(() => null);
                objectModules.Sonidero = await import("./objetos/Grabadora.js").catch(() => null);
                objectModules.tapeteaserrin = await import("./objetos/tapeteaserrin.js").catch(() => null);
                objectModules.base = await import("./objetos/base.js").catch(() => null);
                objectModules.velasclonadas = await import("./objetos/velasgrupo.js").catch(() => null);
                
                console.log('Módulos cargados:', Object.keys(objectModules).filter(key => objectModules[key] !== null).length);
                
            } catch (error) {
                console.error('Error cargando módulos:', error);
            }
        }

        // Detectar si es móvil
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        
        // Ocultar loader después de un tiempo máximo (fallback)
        const fallbackTimeout = setTimeout(() => {
            hideLoader();
            console.log('Loader ocultado por timeout de seguridad');
        }, 8000);

        // Función para ocultar el loader
        function hideLoader() {
            const loader = document.getElementById('loader');
            if (loader && loader.style.display !== 'none') {
                loader.style.display = 'none';
                console.log('Loader ocultado correctamente');
            }
            clearTimeout(fallbackTimeout);
        }

        // Función segura para crear objetos
        function createObject(module, params = {}) {
            if (!module || typeof module.default !== 'function') {
                console.warn('Módulo no disponible o no es una función:', module);
                return null;
            }
            
            try {
                const obj = module.default(params);
                if (obj && obj.isObject3D) {
                    return obj;
                } else {
                    console.warn('El objeto creado no es una instancia de Object3D:', obj);
                    return null;
                }
            } catch (error) {
                console.error('Error creando objeto:', error);
                return null;
            }
        }

        async function initializeScene() {
            console.log('Inicializando escena...');
            
            try {
                //🕹️🕹️ Renderer
                var renderer = new THREE.WebGLRenderer({
                    canvas: document.getElementById('myCanvas'), 
                    antialias: !isMobile,
                    powerPreference: "low-power",
                    precision: "mediump"
                });

                renderer.setPixelRatio(isMobile ? 1 : Math.min(1.5, window.devicePixelRatio));
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0x241440);
                renderer.shadowMap.enabled = !isMobile;

                if (!isMobile) {
                    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                }

                // 🎬 Escena
                var scene = new THREE.Scene();

                //🎥🎥 Cámara
                var camera = new THREE.PerspectiveCamera(
                    70, 
                    window.innerWidth / window.innerHeight, 
                    0.1, 
                    isMobile ? 1000 : 2000
                );
                scene.add(camera);
                camera.position.set(0, 120, 400);

                if (isMobile) {
                    camera.fov = 60;
                    camera.updateProjectionMatrix();
                }

                // Controles
                var controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.rotateSpeed = isMobile ? 0.5 : 1.0;
                controls.panSpeed = isMobile ? 0.5 : 1.0;
                controls.maxDistance = isMobile ? 300 : 400;

                //LUCES
                var light1 = new THREE.AmbientLight(0xB08F63, 0.8);
                scene.add(light1);

                var dl01 = new THREE.DirectionalLight(0xCDA6FF, 0.4);
                dl01.position.set(0, 150, 200);
                scene.add(dl01);

                var sl01 = new THREE.SpotLight(0xFFF8ED, 1.5, 400, 0.6, 0.8, 2);
                sl01.position.set(0, 100, -300);
                scene.add(sl01);

                var sl02 = new THREE.SpotLight(0xffa500, 1.2, 900, 0.9, 1.3, 1);
                sl02.position.set(-80, 300, 100);
                scene.add(sl02);

                if (!isMobile) {
                    sl01.castShadow = true;
                    sl01.shadow.mapSize.width = 1024;
                    sl01.shadow.mapSize.height = 1024;
                    sl01.shadow.camera.near = 10;
                    sl01.shadow.camera.far = 200;
                }

                // Cargar módulos primero
                await loadObjectModules();
                
                // Cargar objetos esenciales
                console.log('Cargando objetos esenciales...');
                const essentialObjects = [];
                
                // Base y estructura
                const BASE1 = createObject(objectModules.base, {x:0, y:0, z: 0});
                if (BASE1) {
                    scene.add(BASE1);
                    essentialObjects.push(BASE1);
                }

                const pisosofrenda = createObject(objectModules.PisosOfrenda, {x:0, y:25, z:-60});
                if (pisosofrenda) {
                    scene.add(pisosofrenda);
                    pisosofrenda.rotation.set(0, 1.57, 0);
                    pisosofrenda.scale.set(2, 2, 2);
                    essentialObjects.push(pisosofrenda);
                }

                const retratojose = createObject(objectModules.retrato1, {x:0, y:75, z:-120});
                if (retratojose) {
                    scene.add(retratojose);
                    essentialObjects.push(retratojose);
                }

                // Velas esenciales
                const vela1 = createObject(objectModules.ESC02, {x:-55, y:40.5, z:-25});
                if (vela1) {
                    scene.add(vela1);
                    essentialObjects.push(vela1);
                }

                const vela2 = createObject(objectModules.ESC02, {x:55, y:40.5, z:-25});
                if (vela2) {
                    scene.add(vela2);
                    essentialObjects.push(vela2);
                }

                console.log(`Objetos esenciales cargados: ${essentialObjects.length}/5`);

                // Si tenemos al menos 3 objetos esenciales, ocultar loader y continuar
                if (essentialObjects.length >= 3) {
                    hideLoader();
                    
                    // Cargar objetos secundarios en segundo plano
                    setTimeout(() => loadSecondaryObjects(scene), 100);
                } else {
                    // Si no hay suficientes objetos, ocultar loader igualmente
                    hideLoader();
                }

                //🎰🎰 Render loop
                function render() {
                    controls.update();
                    renderer.render(scene, camera);
                    requestAnimationFrame(render);
                }
                render();

                // Manejar redimensionado
                window.addEventListener('resize', function() {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });

            } catch (error) {
                console.error('Error crítico inicializando escena:', error);
                hideLoader();
            }
        }

        function loadSecondaryObjects(scene) {
            console.log('Cargando objetos secundarios...');
            
            // Cargar objetos adicionales de forma segura
            const secondaryObjects = [
                { module: objectModules.ESC01, params: {x:-30, y:39, z:-50} },
                { module: objectModules.ESC03, params: {x:-30, y:36, z:-40} },
                { module: objectModules.ESC04, params: {x:-50, y:47, z:-75}, rotation: {x:0, y:1.57, z:0} },
                { module: objectModules.ESC05, params: {x:30, y:47, z:-45} },
                { module: objectModules.ESC06, params: {x:30, y:62, z:-110} },
                { module: objectModules.ESC07, params: {x:-80, y:10, z:-10} },
                { module: objectModules.ESC08, params: {x:80, y:10, z:-10} },
                { module: objectModules.ESC09, params: {x:-50, y:40, z:-100}, scale: {x:0.5, y:0.5, z:0.5} },
                { module: objectModules.ESC10, params: {x:50, y:38, z:-40} },
                { module: objectModules.tequila, params: {x:5, y:50, z:-85} },
                { module: objectModules.retrato2, params: {x:-22, y:55, z:-85} },
                { module: objectModules.retrato3, params: {x:0, y:40, z:-39} },
                { module: objectModules.agua, params: {x:-20, y:44.5, z:-50} },
                { module: objectModules.MANGO, params: {x:-37, y:60, z:-70} },
                { module: objectModules.mandarina, params: {x:-35, y:43, z:-70}, scale: {x:1, y:0.8, z:1} },
                { module: objectModules.MANZANA, params: {x:-32, y:60, z:-70} },
                { module: objectModules.Pozole1, params: {x:-20, y:30, z:-30} },
                { module: objectModules.Pozole1, params: {x:-30, y:48, z:-110} },
                { module: objectModules.Vinyl, params: {x:-5, y:26, z:-76}, scale: {x:2, y:2, z:2} },
                { module: objectModules.CUENCO, params: {x:-35, y:45.2, z:-70} },
                { module: objectModules.catrin, params: {x:40, y:105, z:-100}, scale: {x:2, y:2, z:2} },
                { module: objectModules.flor, params: {x:-28, y:14, z:125}, scale: {x:0.7, y:0.7, z:0.7} },
                { module: objectModules.velasclonadas, params: {x:0, y:10, z: 0} },
                { module: objectModules.arcoflores, params: {x:-60, y:18, z:-150}, scale: {x:0.7, y:0.8, z:0.7} },
                { module: objectModules.arcoflores, params: {x:-30, y:16, z:130}, scale: {x:0.35, y:0.3, z:0.3} },
                { module: objectModules.tapeteaserrin, params: {x:-180, y:105, z:-100}, position: {x:0, y:0, z:2} },
                { module: objectModules.vallas, params: {x:-160, y:25, z:300}, scale: {x:1, y:1, z:1} },
                { module: objectModules.farol, params: {x:-130, y:150, z:-140}, scale: {x:3, y:2.6, z:2} },
                { module: objectModules.farol, params: {x:-130, y:150, z:280}, scale: {x:3, y:2.6, z:2} },
                { module: objectModules.farolgrande, params: {x:-130, y:150, z:175}, scale: {x:2.4, y:2.6, z:2}, rotation: {x:0, y:1.57, z:0} },
                { module: objectModules.farolgrande, params: {x:140, y:150, z:175}, scale: {x:2.4, y:2.6, z:2}, rotation: {x:0, y:1.57, z:0} },
                { module: objectModules.catrina, params: {x:-180, y:105, z:-100}, scale: {x:2, y:2, z:2} },
                { module: objectModules.whiskey, params: {x:-16, y:71.5, z:-110} },
                { module: objectModules.Micro, params: {x:50, y:40, z:-115} },
                { module: objectModules.Caballo, params: {x:16, y:69, z:-110} },
                { module: objectModules.Crucifijo, params: {x:0, y:75, z:-134}, scale: {x:2, y:2, z:2} },
                { module: objectModules.Sonidero, params: {x:50, y:40, z:-80}, rotation: {x:0, y:1.57, z:0} },
                { module: objectModules.Aguan, params: {x:-10, y:50, z:-70} }
            ];

            // Cargar objetos con un pequeño delay entre ellos para no saturar
            secondaryObjects.forEach((objConfig, index) => {
                setTimeout(() => {
                    const obj = createObject(objConfig.module, objConfig.params);
                    if (obj) {
                        scene.add(obj);
                        
                        // Aplicar transformaciones adicionales
                        if (objConfig.rotation) {
                            obj.rotation.set(
                                objConfig.rotation.x || 0,
                                objConfig.rotation.y || 0,
                                objConfig.rotation.z || 0
                            );
                        }
                        if (objConfig.scale) {
                            obj.scale.set(
                                objConfig.scale.x || 1,
                                objConfig.scale.y || 1,
                                objConfig.scale.z || 1
                            );
                        }
                        if (objConfig.position) {
                            obj.position.set(
                                objConfig.position.x || 0,
                                objConfig.position.y || 0,
                                objConfig.position.z || 0
                            );
                        }
                    }
                }, index * 50); // 50ms entre cada objeto
            });

            console.log('Todos los objetos secundarios programados para carga');
        }

        // Iniciar la aplicación
        initializeScene();

    </script>
</body>
</html>
