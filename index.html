<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <title>Ofenda por los que ya no estan</title>
    <style>
        #loader {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: #241440; 
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
            font-family: Arial;
            font-size: 18px;
        }
        
        #myCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div id="loader">
        Estableciendo conexi√≥n con los del mas all√°...
        <br>
        Por favor espere
    </div>

    <canvas id="myCanvas"></canvas>

    <script src="./font/KG_HAPPY_Regular.js"></script>

    <script type="importmap"> 
        {
            "imports":{
                "three": "./js/three.module.js",
                "three/OrbitControls": "./js/OrbitControls.js" 
            }
        }
    </script>
    <script type="module"> 
        //üóÉÔ∏èüóÉÔ∏è Mandar llamar a la librer√≠a
        import * as THREE from 'three'; 
        import {OrbitControls} from 'three/OrbitControls';

        import {TextGeometry} from "./js/TextGeometry.js";
        import {FontLoader} from "./js/FontLoader.js";

        // Importar objetos
        import ESC01 from "./objetos/Pan.js"
        import ESC02 from "./objetos/Vela.js"
        import ESC03 from "./objetos/Cocacola.js"
        import ESC04 from "./objetos/Taza1.js"
        import ESC05 from "./objetos/Taza2.js"
        import ESC06 from "./objetos/Taza3.js"
        import ESC07 from "./objetos/Florero.js"
        import ESC08 from "./objetos/Florero2.js"
        import ESC09 from "./objetos/Florero3.js"
        import ESC10 from "./objetos/Copal.js"
        import tequila from "./objetos/Tequila.js"
        import retrato1 from "./objetos/Retrato.js"
        import retrato2 from "./objetos/Retrato2.js"
        import retrato3 from "./objetos/Retrato3.js"
        import agua from "./objetos/Agua.js"
        import mandarina from "./objetos/Mandarina.js"
        import MANGO from "./objetos/mangoamarillo.js"
        import MANZANA from "./objetos/Manzana.js"
        import CUENCO from "./objetos/Cuenco.js"
        import Pozole1 from "./objetos/pozole.js"
        import PisosOfrenda from "./objetos/pisosofrenda.js"
        import Vinyl from "./objetos/cajavinyl.js"
        import catrin from "./objetos/catrin.js"
        import flor from "./objetos/flor.js"
        import arcoflores from "./objetos/arcoflores.js"
        import vallas from "./objetos/vallas.js"
        import farol from "./objetos/farol.js"
        import farolgrande from "./objetos/farol2.js"
        import catrina from "./objetos/catrina.js"
        import whiskey from "./objetos/Wis.js"
        import Aguan from "./objetos/Vaso.js"
        import Micro from "./objetos/Microfono.js"
        import Caballo from "./objetos/Caballito.js"
        import Crucifijo from "./objetos/Cruz.js"
        import Sonidero from "./objetos/Grabadora.js"
        import tapeteaserrin from "./objetos/tapeteaserrin.js"
        import base from "./objetos/base.js"
        import velasclonadas from "./objetos/velasgrupo.js"

        // Detectar si es m√≥vil
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        
        // Ocultar loader despu√©s de un tiempo m√°ximo (fallback)
        setTimeout(() => {
            const loader = document.getElementById('loader');
            if (loader && loader.style.display !== 'none') {
                loader.style.display = 'none';
                console.log('Loader ocultado por timeout');
            }
        }, 5000);

        try {
            //üïπÔ∏èüïπÔ∏è Renderer - Realiza una conexi√≥n entre el c√≥digo y el canvas
            var renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('myCanvas'), 
                antialias: !isMobile,
                powerPreference: "low-power",
                precision: "mediump"
            });

            // Configurar pixel ratio para m√≥viles
            renderer.setPixelRatio(isMobile ? 1 : Math.min(1.5, window.devicePixelRatio));
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x241440);

            // Configurar sombras solo para desktop
            renderer.shadowMap.enabled = !isMobile;
            if (!isMobile) {
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            }

            // üé¨ Creando nueva escena
            var scene = new THREE.Scene();

            //üé•üé• Agregar una c√°mara de perspectiva
            var camera = new THREE.PerspectiveCamera(
                70, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                isMobile ? 1000 : 2000
            );
            scene.add(camera);

            // Settings de la c√°mara
            camera.position.set(0, 120, 400);

            // Ajustar c√°mara para m√≥viles
            if (isMobile) {
                camera.fov = 60;
                camera.updateProjectionMatrix();
            }

            // A√±adiendo los OrbitControls
            var controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.rotateSpeed = isMobile ? 0.5 : 1.0;
            controls.panSpeed = isMobile ? 0.5 : 1.0;
            controls.maxDistance = isMobile ? 300 : 400;

            //LUCES
            var light1 = new THREE.AmbientLight(0xB08F63, 0.8);
            scene.add(light1);

            var dl01 = new THREE.DirectionalLight(0xCDA6FF, 0.4);
            dl01.position.set(0, 150, 200);
            scene.add(dl01);

            var sl01 = new THREE.SpotLight(0xFFF8ED, 1.5, 400, 0.6, 0.8, 2);
            sl01.position.set(0, 100, -300);
            scene.add(sl01);

            var sl02 = new THREE.SpotLight(0xffa500, 1.2, 900, 0.9, 1.3, 1);
            sl02.position.set(-80, 300, 100);
            scene.add(sl02);

            // Configurar sombras solo en desktop
            if (!isMobile) {
                sl01.castShadow = true;
                sl01.shadow.mapSize.width = 1024;
                sl01.shadow.mapSize.height = 1024;
                sl01.shadow.camera.near = 10;
                sl01.shadow.camera.far = 200;
            }

            // Funci√≥n para ocultar el loader
            function hideLoader() {
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.style.display = 'none';
                    console.log('Loader ocultado correctamente');
                }
            }

            // Contador de objetos cargados
            let objectsLoaded = 0;
            const totalEssentialObjects = 5;

            function objectLoaded() {
                objectsLoaded++;
                console.log(`Objetos cargados: ${objectsLoaded}/${totalEssentialObjects}`);
                
                // Cuando todos los objetos esenciales est√©n cargados, ocultar loader
                if (objectsLoaded >= totalEssentialObjects) {
                    setTimeout(hideLoader, 500);
                }
            }

            // Cargar objetos esenciales primero
            function loadEssentialObjects() {
                console.log('Cargando objetos esenciales...');
                
                try {
                    const BASE1 = base({x:0, y:0, z: 0});
                    scene.add(BASE1);
                    objectLoaded();

                    const pisosofrenda = PisosOfrenda({x:0, y:25, z:-60});
                    scene.add(pisosofrenda);
                    pisosofrenda.rotation.set(0, 1.57, 0);
                    pisosofrenda.scale.set(2, 2, 2);
                    objectLoaded();

                    const retratojose = retrato1({x:0, y:75, z:-120});
                    scene.add(retratojose);
                    objectLoaded();

                    // Velas esenciales
                    const vela1 = ESC02({x:-55, y:40.5, z:-25});
                    scene.add(vela1);
                    objectLoaded();

                    const vela2 = ESC02({x:55, y:40.5, z:-25});
                    scene.add(vela2);
                    objectLoaded();

                    // Cargar objetos secundarios despu√©s
                    setTimeout(loadSecondaryObjects, 100);

                } catch (error) {
                    console.error('Error cargando objetos esenciales:', error);
                    hideLoader(); // Ocultar loader incluso si hay error
                }
            }

            function loadSecondaryObjects() {
                console.log('Cargando objetos secundarios...');
                
                try {
                    if (!isMobile) {
                        const vela3 = ESC02({x:-55, y:40.5, z:-135});
                        scene.add(vela3);
                        const vela4 = ESC02({x:55, y:40.5, z:-135});
                        scene.add(vela4);
                    }

                    const pan = ESC01({x:-30, y:39, z:-50});
                    scene.add(pan);

                    const coca = ESC03({x:-30, y:36, z:-40});
                    scene.add(coca);

                    const taza = ESC04({x:-50, y:47, z:-75});
                    scene.add(taza);
                    taza.rotation.set(0, 1.57, 0);

                    const taza2 = ESC05({x:30, y:47, z:-45});
                    scene.add(taza2);

                    const taza3 = ESC06({x:30, y:62, z:-110});
                    scene.add(taza3);

                    const florero1 = ESC07({x:-80, y:10, z:-10});
                    scene.add(florero1);

                    const florero2 = ESC08({x:80, y:10, z:-10});
                    scene.add(florero2);

                    const florero3 = ESC09({x:-50, y:40, z:-100});
                    scene.add(florero3);
                    florero3.scale.set(.5, .5, .5);

                    const copal = ESC10({x:50, y:38, z:-40});
                    scene.add(copal);

                    const tequilita = tequila({x:5, y:50, z:-85});
                    scene.add(tequilita);

                    const retratojuan = retrato2({x:-22, y:55, z:-85});
                    scene.add(retratojuan);

                    const retratovale = retrato3({x:0, y:40, z:-39});
                    scene.add(retratovale);

                    const Agua = agua({x:-20, y:44.5, z:-50});
                    scene.add(Agua);

                    const Mango = MANGO({x:-37, y:60, z:-70});
                    scene.add(Mango);

                    const Mandarina = mandarina({x:-35, y:43, z:-70});
                    scene.add(Mandarina);
                    Mandarina.scale.set(1, .8, 1);

                    const Manzana = MANZANA({x:-32, y:60, z:-70});
                    scene.add(Manzana);

                    const pozole = Pozole1({x:-20, y:30, z:-30});
                    scene.add(pozole);

                    const pozole2 = Pozole1({x:-30, y:48, z:-110});
                    scene.add(pozole2);

                    const DiscoVinyl = Vinyl({x:-5, y:26, z:-76});
                    scene.add(DiscoVinyl);
                    DiscoVinyl.scale.set(2, 2, 2);

                    const Cuenco = CUENCO({x:-35, y:45.2, z:-70});
                    scene.add(Cuenco);

                    const Catrin = catrin({x:40, y:105, z:-100});
                    scene.add(Catrin);
                    Catrin.scale.set(2, 2, 2);

                    const Flor = flor({x:-28, y:14, z:125});
                    scene.add(Flor);
                    Flor.scale.set(0.7, 0.7, 0.7);

                    const velasclonadas01 = velasclonadas({x:0, y:10, z: 0});
                    scene.add(velasclonadas01);

                    const ARCOFLORES = arcoflores({x:-60, y:18, z:-150});
                    scene.add(ARCOFLORES);
                    ARCOFLORES.scale.set(0.7, 0.8, 0.7);

                    const ARCOFLORES2 = arcoflores({x:-30, y:16, z:130});
                    scene.add(ARCOFLORES2);
                    ARCOFLORES2.scale.set(0.35, 0.3, 0.3);

                    //Tapete aserr√≠n 
                    const TAPETEASERRIN = tapeteaserrin({x:-180, y:105, z:-100});
                    scene.add(TAPETEASERRIN);
                    TAPETEASERRIN.position.set(0, 0, 2);

                    //VALLAS EXTERIORES
                    const VALLAS = vallas({x:-160, y:25, z:300});
                    scene.add(VALLAS);
                    VALLAS.scale.set(1, 1, 1);

                    //FAROLES CON LUCES
                    const FAROL = farol({x:-130, y:150, z:-140});
                    scene.add(FAROL);
                    FAROL.scale.set(3, 2.6, 2);

                    const FAROL2 = farol({x:-130, y:150, z:280});
                    scene.add(FAROL2);
                    FAROL2.scale.set(3, 2.6, 2);

                    const FAROLGRANDE = farolgrande({x:-130, y:150, z:175});
                    scene.add(FAROLGRANDE);
                    FAROLGRANDE.scale.set(2.4, 2.6, 2);
                    FAROLGRANDE.rotation.set(0, 1.57, 0);

                    const FAROLGRANDE2 = farolgrande({x:140, y:150, z:175});
                    scene.add(FAROLGRANDE2);
                    FAROLGRANDE2.scale.set(2.4, 2.6, 2);
                    FAROLGRANDE2.rotation.set(0, 1.57, 0);

                    const CATRINA = catrina({x:-180, y:105, z:-100});
                    scene.add(CATRINA);
                    CATRINA.scale.set(2, 2, 2);

                    const wiskito = whiskey({x:-16, y:71.5, z:-110});
                    scene.add(wiskito);

                    const microfono = Micro({x:50, y:40, z:-115});
                    scene.add(microfono);

                    const tequilero = Caballo({x:16, y:69, z:-110});
                    scene.add(tequilero);

                    const diosito = Crucifijo({x:0, y:75, z:-134});
                    scene.add(diosito);
                    diosito.scale.set(2, 2, 2);

                    const godcina = Sonidero({x:50, y:40, z:-80});
                    scene.add(godcina);
                    godcina.rotation.set(0, 1.57, 0);

                    const vasodeagua = Aguan({x:-10, y:50, z:-70});
                    scene.add(vasodeagua);

                    // Solo en desktop, cargar velas adicionales
                    if (!isMobile) {
                        const vela5 = ESC02({x:34, y:55, z:-135});
                        scene.add(vela5);
                        vela5.scale.set(1.5, 2, 1.5);

                        const vela6 = ESC02({x:-34, y:55, z:-135});
                        scene.add(vela6);
                        vela6.scale.set(1.5, 2, 1.5);
                    }

                    console.log('Todos los objetos cargados correctamente');

                } catch (error) {
                    console.error('Error cargando objetos secundarios:', error);
                }
            }

            // Iniciar carga de objetos inmediatamente
            loadEssentialObjects();

            //üé∞üé∞ Rendering y animaci√≥n optimizada
            let frameCount = 0;
            function render() {
                frameCount++;
                
                // En m√≥viles, actualizar controles cada 2 frames para mejor performance
                if (!isMobile || frameCount % 2 === 0) {
                    controls.update();
                }

                renderer.render(scene, camera);
                requestAnimationFrame(render);
            }

            // Iniciar renderizado inmediatamente
            requestAnimationFrame(render);

            // Manejar redimensionado de ventana
            window.addEventListener('resize', function() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

        } catch (error) {
            console.error('Error cr√≠tico al inicializar Three.js:', error);
            // Ocultar loader incluso si hay error cr√≠tico
            hideLoader();
        }

    </script>
</body>
</html>
